<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cheeki's Mods Archive</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hide-videos iframe {
      display: none;
    }
    h3, .platform-block {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rating {
      flex-shrink: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans p-4">
  <div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-1 gap-2">
      <h1 class="text-3xl font-bold">Cheeki's Mods Archive</h1>
      <div class="flex gap-2">
        <button id="toggle-videos" aria-label="Toggle videos visibility" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-medium py-1 px-2 rounded">
          Hide videos
        </button>
        <button id="contact-button" aria-label="Contact me" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-medium py-1 px-2 rounded">
          Contact me
        </button>
      </div>
    </div>

    <h2 class="text-lg text-gray-400 mb-3">A collection of S.T.A.L.K.E.R. Story Mods</h2>
    <p class="text-gray-300 text-sm mb-6">
      A non-exhaustive archive of game modifications for the S.T.A.L.K.E.R. game franchise, mainly story-focused mods I reviewed on the YouTube Channel.
      Everything listed here is for ease-of-access and posterity only. Consolidating files that tend to be scattered accross multiple websites, hosting services, with some unfortunately lost already. 
      All credits go to the Authors of these mods.
    </p>

    <div class="flex flex-wrap items-center gap-2 mb-4">
      <button id="sort-button" aria-label="Sort mods by rating" class="bg-yellow-500 hover:bg-yellow-600 text-black text-sm font-medium py-1 px-3 rounded w-32 text-center">
        Sort by Rating
      </button>
      <input id="search-input" type="text" aria-label="Search mods" placeholder="Search mods..." class="flex-1 min-w-[150px] px-2 py-1 text-sm rounded bg-gray-800 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
    </div>

    <div id="mod-list" class="grid gap-4 grid-cols-[repeat(auto-fill,minmax(300px,1fr))]"></div>

    <footer class="mt-8 text-center text-sm text-gray-500">
      Cheeki's Mods Archive - <a href="https://linktr.ee/cheekibreekii" target="_blank" class="text-blue-400 hover:underline">Check me Out!</a>
    </footer>
  </div>

  <!-- Install Guide Popup -->
  <div id="popup-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
    <div class="bg-gray-900 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-auto relative p-4">
      <button id="popup-close" aria-label="Close popup" class="absolute top-2 right-2 text-gray-400 hover:text-white text-xl">&times;</button>
      <div id="popup-content" class="text-sm text-gray-200">Loading...</div>
    </div>
  </div>

  <!-- Contact Me Popup -->
  <div id="contact-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
    <div class="bg-gray-900 rounded-lg max-w-md w-full p-4 relative text-sm text-gray-200">
      <button id="contact-close" aria-label="Close contact popup" class="absolute top-2 right-2 text-gray-400 hover:text-white text-xl">&times;</button>
      <p class="mb-4">Only use this to report a broken link or incorrect information that needs fixing.</p>
      <div class="flex items-center gap-2">
        <button id="reveal-email" class="bg-yellow-500 hover:bg-yellow-600 text-black text-xs font-medium py-1 px-2 rounded">
          Reveal Email
        </button>
        <p id="email-text" class="text-blue-400 hidden">cheekitos@proton.me</p>
      </div>
    </div>
  </div>

  <script>
    // Cache DOM elements
    const elements = {
      modList: document.getElementById('mod-list'),
      sortButton: document.getElementById('sort-button'),
      searchInput: document.getElementById('search-input'),
      toggleVideos: document.getElementById('toggle-videos'),
      popupOverlay: document.getElementById('popup-overlay'),
      popupContent: document.getElementById('popup-content'),
      popupClose: document.getElementById('popup-close'),
      contactOverlay: document.getElementById('contact-overlay'),
      contactButton: document.getElementById('contact-button'),
      contactClose: document.getElementById('contact-close'),
      revealEmail: document.getElementById('reveal-email'),
      emailText: document.getElementById('email-text')
    };

    // State variables
    let mods = [];
    let originalMods = [];
    let sortState = 0; // 0: original, 1: highest, 2: lowest
    let currentFilter = '';

    // Cache star HTML templates
    const starTemplates = {
      full: '<svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.122-6.545L.487 6.91l6.561-.955L10 0l2.952 5.955 6.561.955-4.757 4.635 1.122 6.545z"/></svg>',
      half: '<svg class="w-4 h-4" viewBox="0 0 20 20"><defs><linearGradient id="halfGrad" x1="0" x2="100%" y1="0" y2="0"><stop offset="50%" stop-color="#facc15"/><stop offset="50%" stop-color="#4b5563"/></linearGradient></defs><path fill="url(#halfGrad)" d="M10 15l-5.878 3.09 1.122-6.545L.487 6.91l6.561-.955L10 0l2.952 5.955 6.561.955-4.757 4.635 1.122 6.545z"/></svg>',
      empty: '<svg class="w-4 h-4 fill-gray-600" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.122-6.545L.487 6.91l6.561-.955L10 0l2.952 5.955 6.561.955-4.757 4.635 1.122 6.545z"/></svg>'
    };

    // Cached star ratings HTML
    const starCache = new Map();

    // Debounce utility
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    async function loadMods() {
      try {
        const response = await fetch(`mods.json?v=${Date.now()}`);
        mods = await response.json();
        originalMods = [...mods];
        renderMods(mods);
      } catch (err) {
        console.error('Error loading mods.json:', err);
      }
    }

    function renderStars(rating) {
      if (starCache.has(rating)) {
        return starCache.get(rating);
      }

      let starsHTML = '';
      for (let i = 1; i <= 5; i++) {
        if (rating >= i) {
          starsHTML += starTemplates.full;
        } else if (rating + 0.5 >= i) {
          starsHTML += starTemplates.half;
        } else {
          starsHTML += starTemplates.empty;
        }
      }

      starCache.set(rating, starsHTML);
      return starsHTML;
    }

    function createModCard(mod) {
      const card = document.createElement('div');
      card.className = 'bg-gray-800 p-3 rounded-md shadow-sm flex flex-col h-full justify-between';

      // Create platform options efficiently
      const platforms = ['Shadow of Chernobyl', 'Clear Sky', 'Call of Pripyat'];
      const platformHTML = platforms.map((plat, idx) => {
        const isActive = mod.platform === plat;
        const spanClass = isActive 
          ? 'border border-white bg-yellow-400 bg-opacity-50 px-2 py-0.5 rounded-sm text-[10px] text-white leading-tight inline-block'
          : 'text-gray-400 text-[10px] leading-tight inline-block';
        const separator = idx < platforms.length - 1 ? '<span class="text-gray-400 text-[10px] leading-tight inline-block mx-1">|</span>' : '';
        return `<span class="${spanClass}">${plat}</span>${separator}`;
      }).join(' ');

      // Build links HTML
      const linksHTML = (mod.links || []).map(link => {
        const isInstallGuide = link.label.toLowerCase().includes('install guide');
        const target = isInstallGuide ? '' : 'target="_blank"';
        const dataGuide = isInstallGuide ? `data-guide-url="${link.url}"` : '';
        return `<a href="${link.url}" ${target} ${dataGuide} class="block text-blue-400 hover:underline text-sm cursor-pointer">${link.label}</a>`;
      }).join('');

      card.innerHTML = `
        <div class="flex-shrink-0">
          <div class="flex justify-between items-center mb-3 gap-2">
            <h3 class="text-2xl font-semibold text-gray-100 drop-shadow" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${mod.title}</h3>
            <div class="flex items-center space-x-0.5 text-yellow-400 rating">${renderStars(mod.rating)}</div>
          </div>
          
          <div class="text-xs text-white mb-2 flex items-baseline gap-2">
            <span class="leading-tight">Standalone:</span>
            <div class="flex items-center gap-1">
              <span class="${mod.standalone ? 'border border-white px-2 py-0.5 rounded-sm text-[10px] text-white leading-tight' : 'text-gray-400 text-[10px] leading-tight'}" ${mod.standalone ? 'style="background-color: rgba(250, 204, 21, 0.45);"' : ''}>Yes</span>
              <span class="text-gray-400 text-[10px] leading-tight">|</span>
              <span class="${!mod.standalone ? 'border border-white px-2 py-0.5 rounded-sm text-[10px] text-white leading-tight' : 'text-gray-400 text-[10px] leading-tight'}" ${!mod.standalone ? 'style="background-color: rgba(250, 204, 21, 0.45);"' : ''}>No</span>
            </div>
          </div>
          
          <div class="text-xs text-white mb-2 platform-block" style="display: flex; align-items: baseline; gap: 0.5rem; min-width: 0;">
            <span class="leading-tight" style="flex-shrink: 0;">Platform:</span>
            <div style="flex: 1; min-width: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${platformHTML}</div>
          </div>
          
          <p class="text-gray-400 text-sm">${mod.description}</p>
        </div>
        
        <div class="flex-shrink-0 mt-4">
          <div class="mb-2">${linksHTML}</div>
          
          <div>
            <iframe src="${mod.video}" class="w-full aspect-video rounded" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
        </div>
      `;

      return card;
    }

    function renderMods(modArray) {
      const fragment = document.createDocumentFragment();
      modArray.forEach(mod => {
        fragment.appendChild(createModCard(mod));
      });
      elements.modList.innerHTML = '';
      elements.modList.appendChild(fragment);
    }

    function filterMods(query) {
      const q = query.toLowerCase();
      return mods.filter(mod =>
        mod.title.toLowerCase().includes(q) ||
        mod.description.toLowerCase().includes(q) ||
        (mod.platform && mod.platform.toLowerCase().includes(q))
      );
    }

    function openPopup(url) {
      elements.popupContent.innerHTML = 'Loading...';
      elements.popupOverlay.classList.remove('hidden');
      
      fetch(`${url}?v=${Date.now()}`)
        .then(res => {
          if (!res.ok) throw new Error('Failed to load');
          return res.text();
        })
        .then(html => {
          elements.popupContent.innerHTML = html;
          elements.popupContent.scrollTop = 0;
        })
        .catch(() => {
          elements.popupContent.innerHTML = '<p class="text-red-400">Failed to load guide.</p>';
        });
    }

    function closePopups() {
      elements.popupOverlay.classList.add('hidden');
      elements.contactOverlay.classList.add('hidden');
    }

    // Debounced search handler
    const debouncedSearch = debounce((query) => {
      currentFilter = query;
      const filtered = filterMods(query);
      renderMods(filtered);
    }, 300);

    // Event listeners using event delegation where appropriate
    elements.modList.addEventListener('click', (e) => {
      if (e.target.matches('[data-guide-url]')) {
        e.preventDefault();
        openPopup(e.target.dataset.guideUrl);
      }
    });

    elements.sortButton.addEventListener('click', () => {
      sortState = (sortState + 1) % 3;
      
      const baseArray = currentFilter ? filterMods(currentFilter) : originalMods;
      let toRender;
      
      switch(sortState) {
        case 0: // Original order
          elements.sortButton.textContent = 'Sort by Rating';
          toRender = baseArray;
          break;
        case 1: // Highest to lowest
          elements.sortButton.textContent = 'Highest';
          toRender = [...baseArray].sort((a, b) => parseFloat(b.rating) - parseFloat(a.rating));
          break;
        case 2: // Lowest to highest
          elements.sortButton.textContent = 'Lowest';
          toRender = [...baseArray].sort((a, b) => parseFloat(a.rating) - parseFloat(b.rating));
          break;
      }
      
      renderMods(toRender);
    });

    elements.searchInput.addEventListener('input', (e) => {
      debouncedSearch(e.target.value);
    });

    elements.toggleVideos.addEventListener('click', () => {
      const isHiding = document.body.classList.toggle('hide-videos');
      elements.toggleVideos.textContent = isHiding ? 'Show Videos' : 'Hide Videos';
    });

    // Popup event listeners
    elements.popupClose.addEventListener('click', closePopups);
    elements.popupOverlay.addEventListener('click', (e) => {
      if (e.target === elements.popupOverlay) closePopups();
    });

    // Contact popup event listeners
    elements.contactButton.addEventListener('click', () => {
      elements.contactOverlay.classList.remove('hidden');
    });
    elements.contactClose.addEventListener('click', closePopups);
    elements.contactOverlay.addEventListener('click', (e) => {
      if (e.target === elements.contactOverlay) closePopups();
    });
    elements.revealEmail.addEventListener('click', () => {
      elements.emailText.classList.remove('hidden');
    });

    // Keyboard event listener
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePopups();
    });

    // Initialize
    loadMods();
  </script>
</body>
</html>
